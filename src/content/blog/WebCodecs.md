---
title: "WebCodecs æ¦‚è¿°"
pubDatetime: 2024-07-26T16:34:18+08:00
modDatetime: 2024-07-26T16:34:18+08:00
categories:
  - "å‰ç«¯"
tags:
  - "WebCodecs"
  - "Web Worker"
  - "éŸ³è§†é¢‘"
description: "WebCodecs API æä¾›äº†å¯¹æµè§ˆå™¨ä¸­å·²å­˜åœ¨çš„ç¼–è§£ç å™¨çš„è®¿é—®èƒ½åŠ›ã€‚å®ƒå¯ä»¥è®¿é—®åŸå§‹è§†é¢‘å¸§ã€éŸ³é¢‘æ•°æ®å—ã€å›¾åƒè§£ç å™¨ã€éŸ³é¢‘å’Œè§†é¢‘çš„ç¼–ç å™¨åŠè§£ç å™¨ã€‚"
---

## æŠ€æœ¯æ¦‚è¿°

### è¿™æ˜¯ä»€ä¹ˆï¼Ÿ

WebCodecs API æä¾›äº†å¯¹æµè§ˆå™¨ä¸­å·²å­˜åœ¨çš„ç¼–è§£ç å™¨çš„è®¿é—®èƒ½åŠ›ã€‚å®ƒå¯ä»¥è®¿é—®åŸå§‹è§†é¢‘å¸§ã€éŸ³é¢‘æ•°æ®å—ã€å›¾åƒè§£ç å™¨ã€éŸ³é¢‘å’Œè§†é¢‘çš„ç¼–ç å™¨åŠè§£ç å™¨ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ WebCodecs?

æµè§ˆå™¨å†…éƒ¨è‡ªå¸¦äº†åª’ä½“ç¼–ç å™¨åŠŸèƒ½ï¼Œæ¥å¤„ç†ç½‘é¡µä¸­çš„å¤šåª’ä½“ä¿¡æ¯ã€‚æˆ‘ä»¬è°ƒç”¨çš„ä¸€äº› API ä¸­å°±è¿ç”¨äº†è¿™éƒ¨åˆ†çš„èƒ½åŠ›ï¼Œæ¯”å¦‚è¯´ Web Audio API å’Œ WebRTC APIã€‚ä½†æ˜¯è¿™éƒ¨åˆ†çš„ API åªæ˜¯è¾“å‡º MediaStreamï¼Œå¹¶ä¸”æ²¡æœ‰ç¼–è§£ç ç›¸å…³ API çš„æš´éœ²ï¼Œæ‰€ä»¥æ²¡åŠæ³•å¯¹è§†é¢‘æµé‡Œé¢çš„å•ä¸ªå¸§æˆ–è€…æ²¡æœ‰å°è£…çš„ç¼–ç éŸ³é¢‘å—å’Œè§†é¢‘å—ï¼Œè¿™å¯¹äºè¦ä»‹å…¥éŸ³è§†é¢‘åŸå§‹æ•°æ®è¿›è¡Œå¤„ç†çš„åœºæ™¯ï¼ˆæ¯”å¦‚ B ç«™çš„å®æ—¶å¼¹å¹•äººåƒæŠ å›¾èƒ½åŠ›ã€å‰ªæ˜ çš„è§†é¢‘ç¼–è¾‘èƒ½åŠ›ï¼‰æå‡ºäº†æŒ‘æˆ˜ã€‚

- WebAudio åªèƒ½è§£ç å®Œæ•´çš„éŸ³é¢‘æ–‡ä»¶ï¼Œä½†ä¸æ”¯æŒæ•°æ®æµã€ä¸æä¾›è§£ç è¿›åº¦ä¿¡æ¯ã€æ›´ä¸æ”¯æŒç¼–ç 
- MediaRecorder åªèƒ½å½•åˆ¶ç‰¹å®šæ ¼å¼ï¼ˆWebMã€MP4ï¼‰çš„è§†é¢‘ï¼Œæ— æ³•æ§åˆ¶ç¼–ç é€Ÿåº¦ã€è¾“å‡ºç¼“å†²åŒºç­‰
- WebRTC ä¸ MediaStream API é«˜åº¦è€¦åˆï¼Œä¸”ä¸é€æ˜ï¼Œä»…èƒ½ç”¨äºå®æ—¶éŸ³è§†é¢‘é€šä¿¡
- Video æ ‡ç­¾ã€MSE æœ€å¸¸ç”¨äºè§†é¢‘æ’­æ”¾ï¼Œä½†æ— æ³•æ§åˆ¶è§£ç é€Ÿç‡ã€ç¼“å†²åŒºé•¿åº¦ï¼Œä¸”åªæ”¯æŒæ’­æ”¾éƒ¨åˆ†è§†é¢‘å®¹å™¨æ ¼å¼

> #### ğŸ’¡ åè¯è§£é‡Š
>
> - Web Audio APIï¼šè¿™éƒ¨åˆ† API æ˜¯æµè§ˆå™¨ç”¨äºå¤„ç†éŸ³é¢‘çš„ APIï¼Œå¯¹äºæ²¡åšè¿‡ç›¸å…³å·¥ä½œå‰ç«¯æ¥è¯´å¯èƒ½ä¸å¤ªç†Ÿæ‚‰ï¼Œä½†æ˜¯å¯¹äºéŸ³é¢‘åº”ç”¨æ¥è¯´ï¼Œå®ƒå°±æ˜¯éŸ³é¢‘ç•Œçš„ Canvasï¼Œå…¶ä¸­åŒ…å«äº†å¦‚åŒ Canvas ä¸€æ ·å¼ºå¤§çš„éŸ³é¢‘ä¿¡å·æ§åˆ¶æ§åˆ¶æ–¹æ³•ã€‚
> - WebRTC APIï¼šå®ƒç”¨æ¥ä¼ è¾“éŸ³é¢‘å’Œè§†é¢‘åª’ä½“æµï¼Œå¹¶åœ¨å†…éƒ¨å¯¹åª’ä½“è¿›è¡Œç¼–ç å’Œè§£ç ï¼Œç›®å‰å¸‚åœºä¸Šåœ¨çº¿ä¼šè®®è½¯ä»¶éƒ½æœ‰å®ƒçš„èº«å½±
> - MediaStreamï¼šæµç”±å¤šä¸ªè½¨é“ç»„æˆï¼Œä¾‹å¦‚è§†é¢‘æˆ–éŸ³é¢‘è½¨é“ã€‚

### å’ŒåŸæ¥çš„æ–¹æ³•æœ‰ä»€ä¹ˆä¸åŒï¼Ÿ

åŸæ¥åœ¨ Web ä¸Šä¸ºäº†å®ç°è§†é¢‘ç¼–è§£ç èƒ½åŠ›ï¼Œå¯ä»¥ç›´æ¥ç”¨ js å¯¹å¸§è¿›è¡Œå¤„ç†ï¼Œä½†æ˜¯è¿™å¤ªä½æ•ˆäº†ï¼Œä¸€èˆ¬æ–¹æ³•æ˜¯å°† FFmpeg ç¼–è¯‘æˆ WebAssembly ç„¶ååœ¨ web ä¸Šè°ƒç”¨ã€‚
WebAssembly è™½ç„¶ç»™æˆ‘ä»¬å¸¦æ¥ä¾¿åˆ©ï¼Œä½†æ˜¯å®ƒä¹Ÿå­˜åœ¨æ¯”è¾ƒä¸¥é‡çš„é—®é¢˜ï¼Œå…¶ä¸­æœ€æ˜æ˜¾çš„å°±æ˜¯é¢å¤–çš„ç½‘ç»œå¼€é”€ï¼Œç”¨æˆ·ä½¿ç”¨çš„æ—¶å€™éœ€è¦é¢å¤–ä¸‹è½½ ffmpeg.wasm æ–‡ä»¶ï¼Œéœ€è¦ç­‰å¾…è¾ƒé•¿çš„æ—¶é—´ã€‚
åŒæ—¶ç”¨ WebAssembly è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„åŠ£åŠ¿æ˜¯å†…å­˜å¤åˆ¶æˆæœ¬ï¼Œå’Œçº¯ JS å¤„ç†ä¸€æ ·ï¼Œç¼–è§£ç éƒ½éœ€è¦å¤åˆ¶å¸§åˆ°å†…å­˜ä¸­ç„¶åå†ç»™ WebAssemblyï¼Œå¤„ç†ä¸€ä¸ª 1080p çš„è§†é¢‘ï¼Œåœ¨æ¡Œé¢è®¾å¤‡ä¸Šæ¯å¸§çš„å¹³å‡å¤„ç†æ—¶é—´ä¸º 25msï¼Œä¹Ÿå°±æ˜¯ 40fps çš„æ°´å¹³ï¼Œè€Œä½¿ç”¨ Webcodecsï¼Œå¯ä»¥åšåˆ° 1msï¼Œä¹Ÿå°±æ˜¯ 100fpsã€‚
æ‰€ä»¥ç›®å‰æ­£åœ¨ä½¿ç”¨ WebAssembly çš„å‚éƒ½å€¾å‘äºåœ¨ WebAssembly ä¸­å®Œæˆä¸€åˆ‡çš„å¤„ç†ä»¥èŠ‚çœå¸§å¤åˆ¶çš„æ—¶é—´ï¼Œè¿™ä¹Ÿå°±é€ æˆ C/Cpp çš„ä»£ç æ¯”é‡å°±ä¼šåŠ å¤§ã€‚

> #### ğŸ’¡ TIPS
>
> åƒ Figmaã€Zoomï¼Œå®ƒä»¬éƒ½æ˜¯åœ¨ WebAssembly ä¸­å®Œæˆå¯¹å¸§çš„ä¸€åˆ‡ç»˜åˆ¶å’Œåç»­å¤„ç†å·¥ä½œã€‚Figma ç›´æ¥ä½¿ç”¨ WebAssembly æ¥æ“çºµ Canvasï¼Œç›‘å¬äº‹ä»¶æ¥å®ç°ç”¨æˆ·äº¤äº’åŠŸèƒ½ã€‚

### WebCodecs è®¾è®¡ç›®æ ‡

- æµå¼ä¼ è¾“ï¼šå¯¹è¿œç¨‹ã€ç£ç›˜èµ„æºè¿›è¡Œæµå¼è¾“å…¥è¾“å‡º
- æ•ˆç‡ï¼šå……åˆ†åˆ©ç”¨è®¾å¤‡ç¡¬ä»¶ï¼Œåœ¨ Worker ä¸­è¿è¡Œ
- ç»„åˆæ€§ï¼šä¸å…¶ä»– Web APIï¼ˆå¦‚ Streamsã€WebTransport å’Œ WebAssemblyï¼‰é…åˆè‰¯å¥½
- å¯æ¢å¤æ€§ï¼šåœ¨å‡ºç°é—®é¢˜æ—¶èƒ½å¤Ÿæ¢å¤çš„èƒ½åŠ›ï¼ˆç½‘ç»œä¸è¶³ã€èµ„æºç¼ºä¹å¯¼è‡´çš„å¸§ä¸‹é™ç­‰ï¼‰
- çµæ´»æ€§ï¼šèƒ½é€‚åº”å„ç§åœºæ™¯ï¼ˆç¡¬å®æ—¶ã€è½¯å®æ—¶ã€éå®æ—¶ï¼‰ï¼Œèƒ½åœ¨æ­¤ä¹‹ä¸Šå®ç°ç±»ä¼¼ MSE æˆ– WebRTC çš„åŠŸèƒ½
- å¯¹ç§°æ€§ï¼šç¼–ç å’Œè§£ç å…·æœ‰ç›¸ä¼¼çš„æ¨¡å¼

## ç¼–è§£ç æµç¨‹ä»‹ç»

![Alt text](/assets/images/codecs.png)
ä»¥ä¸Šæ˜¯ä¸€ä¸ªè§†é¢‘çš„è§£æå’Œè§£ç è¿‡ç¨‹ï¼ŒWebCodecs å®Œæˆçš„å·¥ä½œä½äºå³ä¾§ç»¿è‰²åŒºåŸŸéƒ¨åˆ†ã€‚

> ### ğŸ’¡ TIPS
>
> ä»å›¾ä¸­ä¹Ÿå¯ä»¥å¾—åˆ°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒWebCodecs åªè´Ÿè´£ç¼–è§£ç ï¼Œä¸ FFmpeg ä¸ä¸€æ ·çš„æ˜¯ï¼Œè§†é¢‘çš„å°è£…å’Œè§£å°è£…ä¸åœ¨å®ƒçš„è®¾è®¡èŒƒå›´å†…ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å…¶å®ƒå·¥å…·æ¥å¸®åŠ©æˆ‘ä»¬å°è£…å’Œè§£å°è£…

åœ¨å¾—åˆ°è§†é¢‘ï¼ˆéŸ³é¢‘ï¼‰æ•°æ®ä¹‹åï¼Œæˆ‘ä»¬é¦–å…ˆè¦å¯¹å…¶è¿›è¡Œè§£å°è£…å¤„ç†ã€‚

> ### ğŸ’¡ TIPS
>
> å°è£…ï¼ˆå®¹å™¨ï¼‰æ ¼å¼ï¼š
> ç¼–ç çš„ä¸»è¦ç›®çš„æ˜¯å‹ç¼©ï¼Œå„ç§ä¸åŒçš„ç¼–ç ç®—æ³•å°±æ˜¯ä¸åŒçš„å‹ç¼©ç®—æ³•ã€‚è€Œè¿™äº›å‹ç¼©çš„æ•°æ®éœ€è¦å…ƒæ•°æ®æ‰å¯ä»¥æ­£ç¡®åœ°è¢«è§£ææ’­æ”¾ï¼Œæ‰€ä»¥å°±éœ€è¦å°è£…ã€‚å¸¸è§çš„å…ƒæ•°æ®åŒ…æ‹¬ï¼šæ—¶é—´ä¿¡æ¯ï¼Œç¼–ç æ ¼å¼ï¼Œåˆ†è¾¨ç‡ï¼Œç ç‡ç­‰ç­‰ã€‚

![Alt text](/assets/images/container-box.png)

å¦‚å›¾æ‰€ç¤ºï¼Œå°è£…æ ¼å¼ä¸­åŒ…å«äº†éŸ³è§†é¢‘çš„ç¼–ç æ•°æ®å’Œå…ƒæ•°æ®ï¼Œè§£å°è£…å·¥å…·å¯ä»¥å¸®æˆ‘ä»¬æŠŠä»–ä»¬åˆ†å¼€æ¥ï¼Œå¾—åˆ° meta dataã€encoded audio chunkã€encoded video chunkã€‚
åœ¨å¾—åˆ°è¿™ä¸‰ä¸ªæ•°æ®ä¹‹åï¼Œæ ¹æ® meta data ä¸­åŒ…å«çš„æ—¶é—´ä¿¡æ¯å’Œç¼–ç æ ¼å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¼€å§‹ä½¿ç”¨ WebCodecs ä¸­çš„ç¼–ç å™¨ API æ¥å¯¹ä¸Šé¢çš„ä¸¤ä¸ªç¼–ç åçš„éŸ³é¢‘å’Œè§†é¢‘æ•°æ®è¿›è¡Œè§£ç å¤„ç†ã€‚
æœ€ç»ˆå¾—åˆ°è§£ç åçš„åŸå§‹å›¾åƒæ•°æ®å’ŒåŸå§‹éŸ³é¢‘æ•°æ®ï¼Œè¿™ä¸¤ä¸ªæ•°æ®å¯ä»¥ä½¿ç”¨ MSE API æ¥æ”¾åˆ° video æˆ–è€… audio æ ‡ç­¾æ’­æ”¾ï¼Œä¹Ÿå¯ä»¥ä½œä¸º CanvasImageSource æ’­æ”¾
ç¼–ç å°±æ˜¯ä»¥ä¸Šæ­¥éª¤é€†å‘æ“ä½œï¼Œå¯¹åº”äº† WebCodecs API çš„è®¾è®¡å®—æ—¨ï¼š

> have similar patterns for encoding and decoding

## å…¼å®¹æ€§å’Œæµè§ˆå™¨æ”¯æŒï¼Ÿ

![Alt text](/assets/images/can-we-use-codecs.png)

## å¼€å‘è€…å·¥å…·å’Œèµ„æº

- Safari å¼€å‘è€…å·¥å…·ï¼šå¯ä»¥å¯è§†åŒ–åœ°è°ƒè¯• canvas å’Œ webgl ä»£ç 
- web-demuxerï¼šåŸºäº ffmpeg çš„è§£å°è£…å·¥å…·
- mp4-muxerï¼šmp4 å°è£…å·¥å…·

> ### ğŸ’¡ TIPS
>
> å…³äºä»¥ä¸Šä¸¤ä¸ªå·¥å…·ï¼Œå…¶å® https://github.com/gpac/mp4box.js/ æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼Œå®ƒåŒæ—¶æœ‰å°è£…å’Œè§£å°è£…èƒ½åŠ›ï¼Œå¹¶ä¸”å¯¹æµçš„æ§åˆ¶æ›´æ–¹ä¾¿ï¼Œä½†æ˜¯å®ƒä¸æ”¯æŒ ts

## å‚è€ƒèµ„æ–™

- [Video Processing With WebCodecs](https://developer.chrome.com/docs/web-platform/best-practices/webcodecs)
- [WebGL2 å›¾åƒå¤„ç†](https://webgl2fundamentals.org/webgl/lessons/zh_cn/webgl-image-processing.html)
- [WebCodecs Tag](https://hughfenghen.github.io/tag/WebCodecs/)
- [å…³äº H.264 çš„ç ç‡ï¼Œ720Pã€1080P è¾“å‡ºæ¯”ç‰¹ç‡è®¾ç½® | Lenix Blog](https://blog.p2hp.com/archives/9617)
- [Webcodecs éŸ³è§†é¢‘ç¼–è§£ç ä¸å°è£…æŠ€æœ¯æ¢ç´¢](https://juejin.cn/post/7361631167065145344#heading-13)
- [åŸºäºWebCodecsçš„ç½‘é¡µç«¯é«˜æ€§èƒ½è§†é¢‘æˆªå¸§](https://www.bilibili.com/read/cv30358687/)
- [YouTube recommended upload encoding settings](https://support.google.com/youtube/answer/1722171?hl=en#zippy=%2Ccontainer-mp%2Caudio-codec-aac-lc%2Cvideo-codec-h%2Cframe-rate%2Cbitrate%2Ccolor-space%2Cvideo-resolution-and-aspect-ratio)
- [Webç«¯H.265æ’­æ”¾å™¨ç ”å‘è§£å¯†](https://fed.taobao.org/blog/taofed/do71ct/web-player-h265/)
